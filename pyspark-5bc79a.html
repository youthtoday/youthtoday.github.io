<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- iOS Safari -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<!-- Chrome, Firefox OS and Opera Status Bar Color -->
<meta name="theme-color" content="#FFFFFF">
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css">
<link rel="stylesheet" type="text/css"
  href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.19.0/themes/prism.min.css">
<link rel="stylesheet" type="text/css" href="css/SourceSansPro.css">
<link rel="stylesheet" type="text/css" href="css/theme.css">
<link rel="stylesheet" type="text/css" href="css/notablog.css">
<!-- Favicon -->

  <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;📖&lt;/text&gt;&lt;/svg&gt;">

<style>
  :root {
    font-size: 20px;
  }
</style>
  <title>基于PySpark的新冠疫情数据分析&nbsp;|&nbsp;Nick的博客</title>
  <meta property="og:type" content="blog">
  <meta property="og:title" content="基于PySpark的新冠疫情数据分析">
  
  
  <style>
    .DateTagBar {
      margin-top: 1.0rem;
    }
  </style>
</head>

<body>
  <nav class="Navbar">
  <a href="index.html">
    <div class="Navbar__Btn">
      
        <span><img class="inline-img-icon" src="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;📖&lt;/text&gt;&lt;/svg&gt;"></span>&nbsp;
      
      <span>Home</span>
    </div>
  </a>
  
    
  
    
  
    
  
    
      <span class="Navbar__Delim">&centerdot;</span>
      <a href="-fe1f32.html">
        <div class="Navbar__Btn">
          
            <span><img class="inline-img-icon" src="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;📚&lt;/text&gt;&lt;/svg&gt;"></span>&nbsp;
          
          <span>分类</span>
        </div>
      </a>
    
  
    
      <span class="Navbar__Delim">&centerdot;</span>
      <a href="about.html">
        <div class="Navbar__Btn">
          
            <span><img class="inline-img-icon" src="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;😀&lt;/text&gt;&lt;/svg&gt;"></span>&nbsp;
          
          <span>关于我</span>
        </div>
      </a>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
</nav>
  <header class="Header">
    
    <div class="Header__Spacer Header__Spacer--NoCover">
    </div>
    
    <h1 class="Header__Title">基于PySpark的新冠疫情数据分析</h1>
    
      <div class="DateTagBar">
        
        
          <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--purple">
            <a href="tag/大数据.html">大数据</a>
          </span>
        
          <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--brown">
            <a href="tag/spark.html">spark</a>
          </span>
        
      </div>
    
  </header>
  <article id="https://www.notion.so/5bc79afc12d14e4cbd1d44f466848ea1" class="PageRoot"><h2 id="https://www.notion.so/6c80354e82204ce189400922fcb58d0d" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/6c80354e82204ce189400922fcb58d0d"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">一、数据源</span></span></h2><h3 id="https://www.notion.so/2f67c1f8929843e4ba60a877af3b858b" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/2f67c1f8929843e4ba60a877af3b858b"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">2019新型冠状病毒疫情时间序列数据仓库</span></span></h3><div id="https://www.notion.so/358922802fc3419395e6b95df7680292" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">本项目为2019新型冠状病毒（COVID-19/2019-nCoV）疫情状况的时间序列数据仓库，数据来源为</span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://3g.dxy.cn/newh5/view/pneumonia">丁香园</a></span><span class="SemanticString">。</span></span></p></div><h3 id="https://www.notion.so/e6b12e43f2f14743923c58be49f1cd8f" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/e6b12e43f2f14743923c58be49f1cd8f"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">链接</span></span></h3><div id="https://www.notion.so/d92d41f8790448fa940208c409fea269" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://github.com/BlankerL/DXY-COVID-19-Data">https://github.com/BlankerL/DXY-COVID-19-Data</a></span><span class="SemanticString"> 
</span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://github.com/BlankerL/DXY-COVID-19-Data/releases/tag/2022.01.04">https://github.com/BlankerL/DXY-COVID-19-Data/releases/tag/2022.01.04</a></span></span></p></div><h2 id="https://www.notion.so/862961e4bd884b0182fe5b1485ca049a" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/862961e4bd884b0182fe5b1485ca049a"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">二、数据预处理</span></span></h2><h3 id="https://www.notion.so/e077432b3659478fbb1a73602afe1652" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/e077432b3659478fbb1a73602afe1652"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">CSV-&gt;TXT</span></span></h3><div id="https://www.notion.so/ff30405c6fe14c6ea73d77a21ae694f4" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">使用pandas进行数据预处理, 在世界范围内的数据中筛选出中国的数据</span></span></p></div><pre id="https://www.notion.so/2351b5fe52a64f06a521da5387683421" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd  
# <span class="token punctuation">.</span>csv<span class="token operator">-</span><span class="token operator">></span><span class="token punctuation">.</span>txt  
data <span class="token operator">=</span> pd<span class="token punctuation">.</span><span class="token function">read_csv</span><span class="token punctuation">(</span><span class="token string">'/home/hadoop/datasets/overall_covid/DXYArea.csv'</span><span class="token punctuation">)</span>
<span class="token keyword">with</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'/home/hadoop/datasets/overall_covid/DXYArea_province.txt'</span><span class="token punctuation">,</span> <span class="token string">'a+'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token literal-property property">f</span><span class="token operator">:</span>
     <span class="token keyword">for</span> line <span class="token keyword">in</span> data<span class="token punctuation">.</span>values<span class="token operator">:</span>
         tmp <span class="token operator">=</span> <span class="token string">""</span>
         <span class="token keyword">if</span> <span class="token function">str</span><span class="token punctuation">(</span>line<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"中国"</span><span class="token operator">:</span>
             <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token literal-property property">line</span><span class="token operator">:</span>
                 tmp <span class="token operator">=</span> tmp <span class="token operator">+</span> <span class="token function">str</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\t'</span>
             tmp <span class="token operator">=</span> tmp <span class="token operator">+</span> <span class="token string">'\n'</span>
             f<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span></span></span></span></code></pre><div id="https://www.notion.so/a94234f541b045dfbce1130d51953f22" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">以下为基础数据结构</span></span></p></div><div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div><div id="https://www.notion.so/f160340cf5184ca4908fdbe81edf70d5" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">等处理好基础文件格式后，将文件上传到HDFS文件系统。之所以要上传到HDFS是因为spark on yarn模式下会进行分布式计算，要使用分布式计算就必须使用分布式文件系统，因此统一上传到HDFS中。</span></span></p></div><h3 id="https://www.notion.so/c152c923b8e34b1ca483702712cc2147" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/c152c923b8e34b1ca483702712cc2147"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">处理日期格式</span></span></h3><div id="https://www.notion.so/e97ec87d97dc4b44aefd74099e41d19d" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">创建RDD的过程中可以使用时间类datetime，这是我们可以对时间进行加减和比较，方便进行后续计算。</span></span></p></div><pre id="https://www.notion.so/8517f2f4670844559792fbb4d5f9be47" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">def</span> <span class="token function">toDate</span><span class="token punctuation">(</span>inputStr<span class="token punctuation">)</span><span class="token punctuation">:</span>
     date <span class="token operator">=</span> datetime<span class="token punctuation">.</span>strptime<span class="token punctuation">(</span>inputStr<span class="token punctuation">,</span> <span class="token string">"%Y-%m-%d %H:%M:%S"</span><span class="token punctuation">)</span><span class="token comment"># 年-月-日 时:分:秒</span>
     <span class="token keyword">return</span> date</span></span></span></code></pre><h3 id="https://www.notion.so/4513be0eae6c433fb6b3829d1f2c26e1" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/4513be0eae6c433fb6b3829d1f2c26e1"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">建立spark连接</span></span></h3><div id="https://www.notion.so/b762a975da104941af77bfaec13555b9" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Spark RDD 编程的程序执行入口是</span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">SparkContext</strong></span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">对象</strong></span><span class="SemanticString">(不论何种编程语言) 只有，构建出SparkContext, 基于它才能执行后续的API调用和计算 本质上, SparkContext对编程来说, 主要功能就是创建第一个RDD出来</span></span></p></div><pre id="https://www.notion.so/e16969790fdb415ba31458a74ec58460" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token comment"># 返回执行应用名称为spark_app的SparkContext对象 </span>
<span class="token keyword">def</span> <span class="token function">connect_to_spark</span><span class="token punctuation">(</span>AppName<span class="token operator">=</span><span class="token string">"spark_app"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
     conf <span class="token operator">=</span> SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span>AppName<span class="token punctuation">)</span>
     spark <span class="token operator">=</span> SparkSession<span class="token punctuation">.</span>builder<span class="token punctuation">.</span>config<span class="token punctuation">(</span>conf<span class="token operator">=</span>conf<span class="token punctuation">)</span><span class="token punctuation">.</span>getOrCreate<span class="token punctuation">(</span><span class="token punctuation">)</span>
     <span class="token keyword">return</span> spark</span></span></span></code></pre><h3 id="https://www.notion.so/53aa7456ddd64399a7b57d6cf0c56bd9" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/53aa7456ddd64399a7b57d6cf0c56bd9"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">TXT-&gt;RDD-&gt;DataFrame</span></span></h3><div id="https://www.notion.so/de410eb4646d43b2aaf38a5d8f840e88" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">RDD的创建主要有2种方式:</span></span></p></div><ol class="NumberedListWrapper"><li id="https://www.notion.so/e797af06c08547ba9488466ab1bcbebb" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">通过并行化集合创建 ( 本地对象转分布式RDD )</span></span></li><li id="https://www.notion.so/59a4e90602a94678b7d0ecd2d1361a49" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString">读取外部数据源 ( 读取文件 )</span></span></li></ol><div id="https://www.notion.so/043c39b44199487eb686a8fcade3e7bf" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">这里我们选择读取HDFS上的txt文件创建RDD，并从RDD创建DataFrame</span></span></p></div><pre id="https://www.notion.so/a12fa24479df467d921b4653a0da6057" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token comment"># 从HDFS的txt文件中获取RDD</span>
<span class="token keyword">def</span> <span class="token function">get_dataframe_from_txt</span><span class="token punctuation">(</span>hdfsurl<span class="token punctuation">,</span> spark<span class="token punctuation">:</span> SparkSession<span class="token punctuation">)</span><span class="token punctuation">:</span>
     <span class="token comment"># "hdfs://Master:9000/user/hadoop/covid/DXYArea_China.txt"</span>
     <span class="token comment"># 创建RDD模式</span>
     fields <span class="token operator">=</span> <span class="token punctuation">[</span>StructField<span class="token punctuation">(</span><span class="token string">"continentName"</span><span class="token punctuation">,</span> StringType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 洲名称</span>
               StructField<span class="token punctuation">(</span><span class="token string">"continentEnglishName"</span><span class="token punctuation">,</span> StringType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 洲名称英文</span>
               StructField<span class="token punctuation">(</span><span class="token string">"countryName"</span><span class="token punctuation">,</span> StringType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 国家名称</span>
               StructField<span class="token punctuation">(</span><span class="token string">"countryEnglishName"</span><span class="token punctuation">,</span> StringType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 国家名称英文</span>
               StructField<span class="token punctuation">(</span><span class="token string">"provinceName"</span><span class="token punctuation">,</span> StringType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 省名称</span>
               StructField<span class="token punctuation">(</span><span class="token string">"provinceEnglishName"</span><span class="token punctuation">,</span> StringType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 省名称英文</span>
               StructField<span class="token punctuation">(</span><span class="token string">"province_zipCode"</span><span class="token punctuation">,</span> StringType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 省邮编</span>
               StructField<span class="token punctuation">(</span><span class="token string">"province_confirmedCount"</span><span class="token punctuation">,</span> IntegerType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 省确诊数</span>
               StructField<span class="token punctuation">(</span><span class="token string">"province_suspectedCount"</span><span class="token punctuation">,</span> IntegerType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 省疑似病例数</span>
               StructField<span class="token punctuation">(</span><span class="token string">"province_curedCount"</span><span class="token punctuation">,</span> IntegerType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 省治愈者数</span>
               StructField<span class="token punctuation">(</span><span class="token string">"province_deadCount"</span><span class="token punctuation">,</span> IntegerType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 省死亡数</span>
               StructField<span class="token punctuation">(</span><span class="token string">"updateTime"</span><span class="token punctuation">,</span> DateType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 更新时间</span>
               StructField<span class="token punctuation">(</span><span class="token string">"cityName"</span><span class="token punctuation">,</span> StringType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 城市名</span>
               StructField<span class="token punctuation">(</span><span class="token string">"cityEnglishName"</span><span class="token punctuation">,</span> StringType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 城市英文名</span>
               StructField<span class="token punctuation">(</span><span class="token string">"city_zipCode"</span><span class="token punctuation">,</span> StringType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 城市邮编</span>
               StructField<span class="token punctuation">(</span><span class="token string">"city_confirmedCount"</span><span class="token punctuation">,</span> IntegerType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 城市确诊数</span>
               StructField<span class="token punctuation">(</span><span class="token string">"city_suspectedCount"</span><span class="token punctuation">,</span> IntegerType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 城市疑似病例数</span>
               StructField<span class="token punctuation">(</span><span class="token string">"city_curedCount"</span><span class="token punctuation">,</span> IntegerType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 城市治愈数</span>
               StructField<span class="token punctuation">(</span><span class="token string">"city_deadCount"</span><span class="token punctuation">,</span> IntegerType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">]</span>  <span class="token comment"># 城市死亡数</span>
     schema <span class="token operator">=</span> StructType<span class="token punctuation">(</span>fields<span class="token punctuation">)</span>     <span class="token comment"># 生成RDD</span>
     rdd0 <span class="token operator">=</span> spark<span class="token punctuation">.</span>sparkContext<span class="token punctuation">.</span>textFile<span class="token punctuation">(</span>hdfsurl<span class="token punctuation">)</span>
     rdd1 <span class="token operator">=</span> rdd0<span class="token punctuation">.</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"\t"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">map</span><span class="token punctuation">(</span>
         <span class="token keyword">lambda</span> p<span class="token punctuation">:</span> Row<span class="token punctuation">(</span>p<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> p<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> p<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> p<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> p<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> p<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span> p<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                       <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token builtin">float</span><span class="token punctuation">(</span>p<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token builtin">float</span><span class="token punctuation">(</span>p<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token builtin">float</span><span class="token punctuation">(</span>p<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token builtin">float</span><span class="token punctuation">(</span>p<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                       toDate<span class="token punctuation">(</span>p<span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> p<span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span><span class="token punctuation">,</span> p<span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span><span class="token punctuation">,</span> p<span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                       <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token builtin">float</span><span class="token punctuation">(</span>p<span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token builtin">float</span><span class="token punctuation">(</span>p<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token builtin">float</span><span class="token punctuation">(</span>p<span class="token punctuation">[</span><span class="token number">17</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token builtin">float</span><span class="token punctuation">(</span>p<span class="token punctuation">[</span><span class="token number">18</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token comment"># 生成DataFrame</span>
     df <span class="token operator">=</span> spark<span class="token punctuation">.</span>createDataFrame<span class="token punctuation">(</span>rdd1<span class="token punctuation">,</span> schema<span class="token punctuation">)</span>
     <span class="token keyword">return</span> df</span></span></span></code></pre><h2 id="https://www.notion.so/7638d749091a4eb9b5564f3e472a65ec" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/7638d749091a4eb9b5564f3e472a65ec"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">三、DataFrame操作</span></span></h2><div id="https://www.notion.so/139eb8b2160b443bb5cf3e6b9ae5b078" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">DataFrame支持两种风格进行编程，分别是：</span></span></p></div><ol class="NumberedListWrapper"><li id="https://www.notion.so/c9389ec2c77e4f069586bb63eb67fc8b" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">DSL风格</span></span><div id="https://www.notion.so/797d38b88b35489486836fdec6b2667f" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">DSL称之为：领域特定语言。 其实就是指DataFrame的特有API DSL风格意思就是以调用API的方式来处理Data 比如：where().limit()</span></span></p></div></li><li id="https://www.notion.so/c9da87cca5b44825a5b052cf47dc0318" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString">SQL风格</span></span><div id="https://www.notion.so/06dcbdb539504a30a6a1bcb2f2710e7a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">SQL风格就是使用SQL语句处理DataFrame的数据 比如：sql(“SELECT * FROM xxx)</span></span></p></div></li></ol><div id="https://www.notion.so/4743529580c04db7af4285fe8f2d3abf" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">在这里，我们使用sparksql对数据进行处理并直接写入mysql</span></span></p></div><h3 id="https://www.notion.so/9e159b70d5524a8d807aff7ac79027ef" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/9e159b70d5524a8d807aff7ac79027ef"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">DSL风格处理城市信息</span></span></h3><div id="https://www.notion.so/4e4c218fcce1409fa3de75c4ab30197e" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">使用API式的SparkSQL，可读性更好，写起来更直观，缺点是如果仅仅使用SparkSQL提供的API，功能受限不自由，重复迭代计算性能一般。</span></span></p></div><div id="https://www.notion.so/a862e45ff9a0482f98e841a400aba8ce" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">数据库结构如下</span></span></p></div><div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div><div id="https://www.notion.so/b9bad8c606a44ebaa94722391e328e4a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">其中，除了confirm_add和id需要计算，其他都可以从原始的DataFrame中读取出来</span></span></p></div><ol class="NumberedListWrapper"><li id="https://www.notion.so/778e32cc363f468d80f3c75ac3b73a16" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">confirm_add的计算</span></span><div id="https://www.notion.so/ac2b9395e92244379d6f74f6f2469f74" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">sessionWindow =partitionBy(&quot;city&quot;).orderBy(&quot;update_time&quot;) # 限定城市并以时间为依据</code></span></span></p></div><div id="https://www.notion.so/1ad0b9b8d187402cadea566e68341283" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">创建以城市为分区，以更新时间为依据，在confirm数据上实现错位相减，让后一天的confirm数据表减去当天confirm，计算出每日该城市的新增确诊病例。</span></span></p></div></li><li id="https://www.notion.so/5c3e86b2696048d8982a37ebcab0f589" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString">id的计算</span></span><div id="https://www.notion.so/1a5ebf4a7af34ca0867fba7850fad862" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">ascendWindow =orderBy(&quot;update_time&quot;) # 生成递增序号</code></span></span></p></div><div id="https://www.notion.so/af468ca3d8dc4d44ba07b1e7b0e7e30d" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">根据时间创建递增序列。</span></span></p></div></li></ol><pre id="https://www.notion.so/6658fbd4e36a40d689e5ece31137d481" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token comment"># DSL风格sparksql，生成城市新冠疫情统计数据 </span>
<span class="token keyword">def</span> <span class="token function">store_city_data</span><span class="token punctuation">(</span>df<span class="token punctuation">:</span> DataFrame<span class="token punctuation">)</span><span class="token punctuation">:</span> 
    df1 <span class="token operator">=</span> df<span class="token punctuation">.</span>select<span class="token punctuation">(</span> 
        <span class="token string">"updateTime"</span><span class="token punctuation">,</span> 
        <span class="token string">"provinceName"</span><span class="token punctuation">,</span> 
        <span class="token string">"cityName"</span><span class="token punctuation">,</span> 
        <span class="token string">"city_confirmedCount"</span><span class="token punctuation">,</span> 
        <span class="token string">"city_curedCount"</span><span class="token punctuation">,</span> 
        <span class="token string">"city_deadCount"</span><span class="token punctuation">,</span> 
    <span class="token punctuation">)</span> 
    <span class="token comment"># DataFrame列重命名 </span>
    df2 <span class="token operator">=</span> df1<span class="token punctuation">.</span>withColumnRenamed<span class="token punctuation">(</span><span class="token string">"updateTime"</span><span class="token punctuation">,</span> <span class="token string">"update_time"</span><span class="token punctuation">)</span><span class="token punctuation">.</span> \ 
        withColumnRenamed<span class="token punctuation">(</span><span class="token string">"provinceName"</span><span class="token punctuation">,</span> <span class="token string">"province"</span><span class="token punctuation">)</span><span class="token punctuation">.</span> \ 
        withColumnRenamed<span class="token punctuation">(</span><span class="token string">"cityName"</span><span class="token punctuation">,</span> <span class="token string">"city"</span><span class="token punctuation">)</span><span class="token punctuation">.</span> \ 
        withColumnRenamed<span class="token punctuation">(</span><span class="token string">"city_confirmedCount"</span><span class="token punctuation">,</span> <span class="token string">"confirm"</span><span class="token punctuation">)</span><span class="token punctuation">.</span> \ 
        withColumnRenamed<span class="token punctuation">(</span><span class="token string">"city_curedCount"</span><span class="token punctuation">,</span> <span class="token string">"heal"</span><span class="token punctuation">)</span><span class="token punctuation">.</span> \ 
        withColumnRenamed<span class="token punctuation">(</span><span class="token string">"city_deadCount"</span><span class="token punctuation">,</span> <span class="token string">"dead"</span><span class="token punctuation">)</span> 
     <span class="token comment"># 根据时间和城市把一天内多次统计的信息去重 </span>
    df3 <span class="token operator">=</span> df2<span class="token punctuation">.</span>dropDuplicates<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'update_time'</span><span class="token punctuation">,</span> <span class="token string">'city'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> 
     <span class="token comment"># 根据时间排序 </span>
    df4 <span class="token operator">=</span> df3<span class="token punctuation">.</span>sort<span class="token punctuation">(</span>df3<span class="token punctuation">[</span><span class="token string">"update_time"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>asc<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
     <span class="token comment"># 创建窗口函数 </span>
    sessionWindow <span class="token operator">=</span> Window<span class="token punctuation">.</span>partitionBy<span class="token punctuation">(</span><span class="token string">"city"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>orderBy<span class="token punctuation">(</span><span class="token string">"update_time"</span><span class="token punctuation">)</span> 
      <span class="token comment"># 限定城市并以时间为依据 </span>
    ascendWindow <span class="token operator">=</span> Window<span class="token punctuation">.</span>orderBy<span class="token punctuation">(</span><span class="token string">"update_time"</span><span class="token punctuation">)</span> 
                           <span class="token comment"># 生成递增序号 </span>
    df5 <span class="token operator">=</span> df4<span class="token punctuation">.</span>withColumn<span class="token punctuation">(</span><span class="token string">"confirm_add"</span><span class="token punctuation">,</span> 
                         func<span class="token punctuation">.</span>lag<span class="token punctuation">(</span>df4<span class="token punctuation">[</span><span class="token string">"confirm"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>over<span class="token punctuation">(</span>sessionWindow<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span> \ 
        withColumn<span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">,</span> func<span class="token punctuation">.</span>row_number<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>over<span class="token punctuation">(</span>ascendWindow<span class="token punctuation">)</span><span class="token punctuation">)</span> 
          <span class="token comment"># 连接并保存到mysql </span>
    df5<span class="token punctuation">.</span>write<span class="token punctuation">.</span>mode<span class="token punctuation">(</span><span class="token string">"overwrite"</span><span class="token punctuation">)</span><span class="token punctuation">.</span> \ 
        <span class="token builtin">format</span><span class="token punctuation">(</span><span class="token string">"jdbc"</span><span class="token punctuation">)</span><span class="token punctuation">.</span> \ 
        option<span class="token punctuation">(</span><span class="token string">"url"</span><span class="token punctuation">,</span> <span class="token string">"jdbc:mysql://Master:3306/covid?useSSL=false&amp;useUnicode=true"</span><span class="token punctuation">)</span><span class="token punctuation">.</span> \ 
        option<span class="token punctuation">(</span><span class="token string">"dbtable"</span><span class="token punctuation">,</span> <span class="token string">"details"</span><span class="token punctuation">)</span><span class="token punctuation">.</span> \ 
        option<span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">,</span> <span class="token string">"root"</span><span class="token punctuation">)</span><span class="token punctuation">.</span> \ 
        option<span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">,</span> <span class="token string">"HUSTeic2021"</span><span class="token punctuation">)</span><span class="token punctuation">.</span> \ 
        save<span class="token punctuation">(</span><span class="token punctuation">)</span></span></span></span></code></pre><div id="https://www.notion.so/268eff838fb34d8eb6843fd3fd29226a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">生成的数据库格式和DataFrame的格式一致</span></span></p></div><div id="https://www.notion.so/321c0f2e1ba3456d83674c51c8c53d6e" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fad3cc581-5b77-4301-91ad-82483c6c51d7%2FUntitled.png?width=840&amp;table=block&amp;id=321c0f2e-1ba3-456d-8367-4c51c8c53d6e"><img src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fad3cc581-5b77-4301-91ad-82483c6c51d7%2FUntitled.png?width=840&amp;table=block&amp;id=321c0f2e-1ba3-456d-8367-4c51c8c53d6e" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><h3 id="https://www.notion.so/debbc1b04c474152a7ac9f67c3f85d50" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/debbc1b04c474152a7ac9f67c3f85d50"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">SQL风格处理全国信息</span></span></h3><div id="https://www.notion.so/9226e91c841b43d2865274e65143e497" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">使用通用SQL形式的SparkSQL，优点是接受度高，而且从DataFrame生成临时表后在使用SQL查询效率更高，而且能实现很多复杂操作，缺点是可读性不如DSL。</span></span></p></div><div id="https://www.notion.so/bd04409da3f2466bb3de85489b0a5cc9" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">数据库结构如下</span></span></p></div><div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div><div id="https://www.notion.so/4711bfa0387b434a95c3f82e25374619" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">计算全国数据的思路如下</span></span></p></div><ol class="NumberedListWrapper"><li id="https://www.notion.so/ebeda8551d5142caac827dfc90fcb8c6" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">我们有各个省份每天都确诊，疑似，治愈，死亡数据，但是不是每天都有各个省份的数据。如果想要计算全国数据的话不能直接简单相加</span></span></li><li id="https://www.notion.so/26e14fbc210f4de692036baad3791a61" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString">由上一个数据库建立的思想可以延伸到本次计算，首先计算每日每省数据新增，按照时间来分组，计算每组各个数据之和即是每日新增数据</span></span></li><li id="https://www.notion.so/8843ec0ccfa54392983a454e599121ee" class="NumberedList" value="3"><span class="SemanticStringArray"><span class="SemanticString">获得每日新增数据后，可以累加逐日数据来计算每日的累计数据</span></span></li></ol><pre id="https://www.notion.so/f6667b34fe6445ea995f6b6fea00368a" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token comment"># SQL风格sparksql，生成全国疫情统计 </span>
<span class="token keyword">def</span> <span class="token function">store_history_data</span><span class="token punctuation">(</span>df<span class="token punctuation">:</span> DataFrame<span class="token punctuation">,</span> sc<span class="token punctuation">:</span> SparkSession<span class="token punctuation">)</span><span class="token punctuation">:</span>
     <span class="token comment"># 从DataFrame中选择合适的数据创建新的DataFrame</span>
     df1 <span class="token operator">=</span> df<span class="token punctuation">.</span>select<span class="token punctuation">(</span>
         <span class="token string">"updateTime"</span><span class="token punctuation">,</span>
	        <span class="token comment"># 更新时间</span>
         <span class="token string">"provinceName"</span><span class="token punctuation">,</span>
	        <span class="token comment"># 省名称</span>
         <span class="token string">"province_confirmedCount"</span><span class="token punctuation">,</span>
          <span class="token comment"># 省确认数</span>
         <span class="token string">"province_suspectedCount"</span><span class="token punctuation">,</span>
          <span class="token comment"># 省疑似数</span>
         <span class="token string">"province_curedCount"</span><span class="token punctuation">,</span>
          <span class="token comment"># 省治愈数</span>
         <span class="token string">"province_deadCount"</span>
          <span class="token comment"># 省死亡数</span>
     <span class="token punctuation">)</span>
          <span class="token comment"># 根据更新时间和省名称去重</span>
     df2 <span class="token operator">=</span> df1<span class="token punctuation">.</span>dropDuplicates<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'updateTime'</span><span class="token punctuation">,</span> <span class="token string">'provinceName'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
          <span class="token comment"># 根据时间升序排序</span>
     df3 <span class="token operator">=</span> df2<span class="token punctuation">.</span>sort<span class="token punctuation">(</span>df2<span class="token punctuation">[</span><span class="token string">"updateTime"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>asc<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token comment"># 由RDD创建临时表</span>
     df3<span class="token punctuation">.</span>createOrReplaceTempView<span class="token punctuation">(</span><span class="token string">"cntotal"</span><span class="token punctuation">)</span>
          <span class="token comment"># 计算疑似病例</span>
     suspect_df <span class="token operator">=</span> sc<span class="token punctuation">.</span>sql<span class="token punctuation">(</span><span class="token string">"select updateTime as ds1,"</span>
                         <span class="token string">"sum(province_suspectedCount) "</span>
                         <span class="token string">"as suspect from cntotal group by updateTime"</span><span class="token punctuation">)</span>
          <span class="token comment"># 计算每个省份对于上次时间的新增数据差</span>
     raw_df <span class="token operator">=</span> sc<span class="token punctuation">.</span>sql<span class="token punctuation">(</span><span class="token string">"select t1.updateTime as ds,"</span>
                     <span class="token string">"t1.province_confirmedCount as confirm,"</span>
                     <span class="token string">"t1.province_suspectedCount as suspect,"</span>
                     <span class="token string">"t1.province_curedCount as heal, "</span>
                     <span class="token string">"t1.province_deadCount as dead, "</span>
                     <span class="token string">"t1.province_confirmedCount-t2.province_confirmedCount as confirm_add, "</span>
                     <span class="token string">"t1.province_suspectedCount-t2.province_suspectedCount as suspect_add, "</span>
                     <span class="token string">"t1.province_curedCount-t2.province_curedCount as heal_add, "</span>
                     <span class="token string">"t1.province_deadCount-t2.province_deadCount as dead_add"</span>
                     <span class="token string">" from cntotal t1,"</span>
                     <span class="token string">"cntotal t2 where t1.updateTime = date_add(t2.updateTime,1) and t1.provinceName = t2.provinceName"</span><span class="token punctuation">)</span>
     raw_df<span class="token punctuation">.</span>createOrReplaceTempView<span class="token punctuation">(</span><span class="token string">"cntotal"</span><span class="token punctuation">)</span>
       <span class="token comment"># 创建临时表</span>
          <span class="token comment"># 计算全国每日新增数据</span>
     diff <span class="token operator">=</span> sc<span class="token punctuation">.</span>sql<span class="token punctuation">(</span><span class="token string">"select ds, sum(confirm_add) as confirm_add, "</span>                   <span class="token string">"sum(suspect_add) as suspect_add, "</span>                   <span class="token string">"sum(heal_add) as heal_add, "</span>                   <span class="token string">"sum(dead_add) as dead_add from cntotal group by ds"</span><span class="token punctuation">)</span>     diff<span class="token punctuation">.</span>createOrReplaceTempView<span class="token punctuation">(</span><span class="token string">"cntotal"</span><span class="token punctuation">)</span>         <span class="token comment"># 创建临时表          # 计算全国逐日累计数据     cum = sc.sql("select ds as ds1, "                  "sum(confirm_add) over(order by ds asc)as confirm , "                  "sum(heal_add) over(order by ds asc) as heal, "                  "sum(dead_add) over(order by ds asc) as dead "                  "from cntotal")          # 将DataFrame进行连接操作，使得三个DataFrame合成一个     history = diff.join(suspect_df, suspect_df["ds1"] == diff["ds"], "inner")     history = history.join(cum, cum["ds1"] == history["ds"], "inner")     history = history.drop("ds1").sort(history["ds"].asc())          # 将DataFrame写入mysql     history.write.mode("overwrite"). \         format("jdbc"). \         option("url", "jdbc:mysql://Master:3306/covid?useSSL=false&amp;useUnicode=true"). \         option("dbtable", "history"). \         option("user", "root"). \         option("password", "HUSTeic2021"). \         save()</span></span></span></span></code></pre><div id="https://www.notion.so/96c840c817104eadbb0fd9cfb1bf776c" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">生成的数据库格式和DataFrame的格式一致</span></span></p></div><div id="https://www.notion.so/db460d152865402fbb2200286147b2be" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fec2d1b7c-77ac-479d-9406-8b80cf21e7b2%2FUntitled.png?width=840&amp;table=block&amp;id=db460d15-2865-402f-bb22-00286147b2be"><img src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fec2d1b7c-77ac-479d-9406-8b80cf21e7b2%2FUntitled.png?width=840&amp;table=block&amp;id=db460d15-2865-402f-bb22-00286147b2be" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div></article>
    <script src="https://utteranc.es/client.js"
        repo="youthtoday/youthtoday.github.io"
        issue-term="pathname"
        label="✨"
        theme="github-light"
        crossorigin="anonymous"
        async>
    </script>
  <footer class="Footer">
  <div>&copy; Nick的博客 2022</div>
  <div>&centerdot;</div>
  <div>Powered by <a href="https://github.com/dragonman225/notablog" target="_blank"
      rel="noopener noreferrer">Notablog</a>.
  </div>
</footer>
</body>

</html>
