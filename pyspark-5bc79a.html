<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- iOS Safari -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<!-- Chrome, Firefox OS and Opera Status Bar Color -->
<meta name="theme-color" content="#FFFFFF">
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css">
<link rel="stylesheet" type="text/css"
  href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.19.0/themes/prism.min.css">
<link rel="stylesheet" type="text/css" href="css/SourceSansPro.css">
<link rel="stylesheet" type="text/css" href="css/theme.css">
<link rel="stylesheet" type="text/css" href="css/notablog.css">
<!-- Favicon -->

  <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;ğŸ“–&lt;/text&gt;&lt;/svg&gt;">

<style>
  :root {
    font-size: 20px;
  }
</style>
  <title>åŸºäºPySparkçš„æ–°å† ç–«æƒ…æ•°æ®åˆ†æ&nbsp;|&nbsp;Nickçš„åšå®¢</title>
  <meta property="og:type" content="blog">
  <meta property="og:title" content="åŸºäºPySparkçš„æ–°å† ç–«æƒ…æ•°æ®åˆ†æ">
  
  
  <style>
    .DateTagBar {
      margin-top: 1.0rem;
    }
  </style>
</head>

<body>
  <nav class="Navbar">
  <a href="index.html">
    <div class="Navbar__Btn">
      
        <span><img class="inline-img-icon" src="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;ğŸ“–&lt;/text&gt;&lt;/svg&gt;"></span>&nbsp;
      
      <span>Home</span>
    </div>
  </a>
  
    
  
    
  
    
  
    
      <span class="Navbar__Delim">&centerdot;</span>
      <a href="-fe1f32.html">
        <div class="Navbar__Btn">
          
            <span><img class="inline-img-icon" src="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;ğŸ“š&lt;/text&gt;&lt;/svg&gt;"></span>&nbsp;
          
          <span>åˆ†ç±»</span>
        </div>
      </a>
    
  
    
      <span class="Navbar__Delim">&centerdot;</span>
      <a href="about.html">
        <div class="Navbar__Btn">
          
            <span><img class="inline-img-icon" src="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;ğŸ˜€&lt;/text&gt;&lt;/svg&gt;"></span>&nbsp;
          
          <span>å…³äºæˆ‘</span>
        </div>
      </a>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
</nav>
  <header class="Header">
    
    <div class="Header__Spacer Header__Spacer--NoCover">
    </div>
    
    <h1 class="Header__Title">åŸºäºPySparkçš„æ–°å† ç–«æƒ…æ•°æ®åˆ†æ</h1>
    
      <div class="DateTagBar">
        
        
          <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--purple">
            <a href="tag/å¤§æ•°æ®.html">å¤§æ•°æ®</a>
          </span>
        
          <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--brown">
            <a href="tag/spark.html">spark</a>
          </span>
        
      </div>
    
  </header>
  <article id="https://www.notion.so/5bc79afc12d14e4cbd1d44f466848ea1" class="PageRoot"><h2 id="https://www.notion.so/6c80354e82204ce189400922fcb58d0d" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/6c80354e82204ce189400922fcb58d0d"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">ä¸€ã€æ•°æ®æº</span></span></h2><h3 id="https://www.notion.so/2f67c1f8929843e4ba60a877af3b858b" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/2f67c1f8929843e4ba60a877af3b858b"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">2019æ–°å‹å† çŠ¶ç—…æ¯’ç–«æƒ…æ—¶é—´åºåˆ—æ•°æ®ä»“åº“</span></span></h3><div id="https://www.notion.so/358922802fc3419395e6b95df7680292" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">æœ¬é¡¹ç›®ä¸º2019æ–°å‹å† çŠ¶ç—…æ¯’ï¼ˆCOVID-19/2019-nCoVï¼‰ç–«æƒ…çŠ¶å†µçš„æ—¶é—´åºåˆ—æ•°æ®ä»“åº“ï¼Œæ•°æ®æ¥æºä¸º</span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://3g.dxy.cn/newh5/view/pneumonia">ä¸é¦™å›­</a></span><span class="SemanticString">ã€‚</span></span></p></div><h3 id="https://www.notion.so/e6b12e43f2f14743923c58be49f1cd8f" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/e6b12e43f2f14743923c58be49f1cd8f"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">é“¾æ¥</span></span></h3><div id="https://www.notion.so/d92d41f8790448fa940208c409fea269" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://github.com/BlankerL/DXY-COVID-19-Data">https://github.com/BlankerL/DXY-COVID-19-Data</a></span><span class="SemanticString"> 
</span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://github.com/BlankerL/DXY-COVID-19-Data/releases/tag/2022.01.04">https://github.com/BlankerL/DXY-COVID-19-Data/releases/tag/2022.01.04</a></span></span></p></div><h2 id="https://www.notion.so/862961e4bd884b0182fe5b1485ca049a" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/862961e4bd884b0182fe5b1485ca049a"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">äºŒã€æ•°æ®é¢„å¤„ç†</span></span></h2><h3 id="https://www.notion.so/e077432b3659478fbb1a73602afe1652" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/e077432b3659478fbb1a73602afe1652"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">CSV-&gt;TXT</span></span></h3><div id="https://www.notion.so/ff30405c6fe14c6ea73d77a21ae694f4" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">ä½¿ç”¨pandasè¿›è¡Œæ•°æ®é¢„å¤„ç†, åœ¨ä¸–ç•ŒèŒƒå›´å†…çš„æ•°æ®ä¸­ç­›é€‰å‡ºä¸­å›½çš„æ•°æ®</span></span></p></div><pre id="https://www.notion.so/2351b5fe52a64f06a521da5387683421" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd  
# <span class="token punctuation">.</span>csv<span class="token operator">-</span><span class="token operator">></span><span class="token punctuation">.</span>txt  
data <span class="token operator">=</span> pd<span class="token punctuation">.</span><span class="token function">read_csv</span><span class="token punctuation">(</span><span class="token string">'/home/hadoop/datasets/overall_covid/DXYArea.csv'</span><span class="token punctuation">)</span>
<span class="token keyword">with</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'/home/hadoop/datasets/overall_covid/DXYArea_province.txt'</span><span class="token punctuation">,</span> <span class="token string">'a+'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token literal-property property">f</span><span class="token operator">:</span>
     <span class="token keyword">for</span> line <span class="token keyword">in</span> data<span class="token punctuation">.</span>values<span class="token operator">:</span>
         tmp <span class="token operator">=</span> <span class="token string">""</span>
         <span class="token keyword">if</span> <span class="token function">str</span><span class="token punctuation">(</span>line<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"ä¸­å›½"</span><span class="token operator">:</span>
             <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token literal-property property">line</span><span class="token operator">:</span>
                 tmp <span class="token operator">=</span> tmp <span class="token operator">+</span> <span class="token function">str</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\t'</span>
             tmp <span class="token operator">=</span> tmp <span class="token operator">+</span> <span class="token string">'\n'</span>
             f<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span></span></span></span></code></pre><div id="https://www.notion.so/a94234f541b045dfbce1130d51953f22" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">ä»¥ä¸‹ä¸ºåŸºç¡€æ•°æ®ç»“æ„</span></span></p></div><div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div><div id="https://www.notion.so/f160340cf5184ca4908fdbe81edf70d5" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">ç­‰å¤„ç†å¥½åŸºç¡€æ–‡ä»¶æ ¼å¼åï¼Œå°†æ–‡ä»¶ä¸Šä¼ åˆ°HDFSæ–‡ä»¶ç³»ç»Ÿã€‚ä¹‹æ‰€ä»¥è¦ä¸Šä¼ åˆ°HDFSæ˜¯å› ä¸ºspark on yarnæ¨¡å¼ä¸‹ä¼šè¿›è¡Œåˆ†å¸ƒå¼è®¡ç®—ï¼Œè¦ä½¿ç”¨åˆ†å¸ƒå¼è®¡ç®—å°±å¿…é¡»ä½¿ç”¨åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿï¼Œå› æ­¤ç»Ÿä¸€ä¸Šä¼ åˆ°HDFSä¸­ã€‚</span></span></p></div><h3 id="https://www.notion.so/c152c923b8e34b1ca483702712cc2147" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/c152c923b8e34b1ca483702712cc2147"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">å¤„ç†æ—¥æœŸæ ¼å¼</span></span></h3><div id="https://www.notion.so/e97ec87d97dc4b44aefd74099e41d19d" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">åˆ›å»ºRDDçš„è¿‡ç¨‹ä¸­å¯ä»¥ä½¿ç”¨æ—¶é—´ç±»datetimeï¼Œè¿™æ˜¯æˆ‘ä»¬å¯ä»¥å¯¹æ—¶é—´è¿›è¡ŒåŠ å‡å’Œæ¯”è¾ƒï¼Œæ–¹ä¾¿è¿›è¡Œåç»­è®¡ç®—ã€‚</span></span></p></div><pre id="https://www.notion.so/8517f2f4670844559792fbb4d5f9be47" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">def</span> <span class="token function">toDate</span><span class="token punctuation">(</span>inputStr<span class="token punctuation">)</span><span class="token punctuation">:</span>
     date <span class="token operator">=</span> datetime<span class="token punctuation">.</span>strptime<span class="token punctuation">(</span>inputStr<span class="token punctuation">,</span> <span class="token string">"%Y-%m-%d %H:%M:%S"</span><span class="token punctuation">)</span><span class="token comment"># å¹´-æœˆ-æ—¥ æ—¶:åˆ†:ç§’</span>
     <span class="token keyword">return</span> date</span></span></span></code></pre><h3 id="https://www.notion.so/4513be0eae6c433fb6b3829d1f2c26e1" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/4513be0eae6c433fb6b3829d1f2c26e1"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">å»ºç«‹sparkè¿æ¥</span></span></h3><div id="https://www.notion.so/b762a975da104941af77bfaec13555b9" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Spark RDD ç¼–ç¨‹çš„ç¨‹åºæ‰§è¡Œå…¥å£æ˜¯</span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">SparkContext</strong></span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">å¯¹è±¡</strong></span><span class="SemanticString">(ä¸è®ºä½•ç§ç¼–ç¨‹è¯­è¨€) åªæœ‰ï¼Œæ„å»ºå‡ºSparkContext, åŸºäºå®ƒæ‰èƒ½æ‰§è¡Œåç»­çš„APIè°ƒç”¨å’Œè®¡ç®— æœ¬è´¨ä¸Š, SparkContextå¯¹ç¼–ç¨‹æ¥è¯´, ä¸»è¦åŠŸèƒ½å°±æ˜¯åˆ›å»ºç¬¬ä¸€ä¸ªRDDå‡ºæ¥</span></span></p></div><pre id="https://www.notion.so/e16969790fdb415ba31458a74ec58460" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token comment"># è¿”å›æ‰§è¡Œåº”ç”¨åç§°ä¸ºspark_appçš„SparkContextå¯¹è±¡ </span>
<span class="token keyword">def</span> <span class="token function">connect_to_spark</span><span class="token punctuation">(</span>AppName<span class="token operator">=</span><span class="token string">"spark_app"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
     conf <span class="token operator">=</span> SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span>AppName<span class="token punctuation">)</span>
     spark <span class="token operator">=</span> SparkSession<span class="token punctuation">.</span>builder<span class="token punctuation">.</span>config<span class="token punctuation">(</span>conf<span class="token operator">=</span>conf<span class="token punctuation">)</span><span class="token punctuation">.</span>getOrCreate<span class="token punctuation">(</span><span class="token punctuation">)</span>
     <span class="token keyword">return</span> spark</span></span></span></code></pre><h3 id="https://www.notion.so/53aa7456ddd64399a7b57d6cf0c56bd9" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/53aa7456ddd64399a7b57d6cf0c56bd9"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">TXT-&gt;RDD-&gt;DataFrame</span></span></h3><div id="https://www.notion.so/de410eb4646d43b2aaf38a5d8f840e88" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">RDDçš„åˆ›å»ºä¸»è¦æœ‰2ç§æ–¹å¼:</span></span></p></div><ol class="NumberedListWrapper"><li id="https://www.notion.so/e797af06c08547ba9488466ab1bcbebb" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">é€šè¿‡å¹¶è¡ŒåŒ–é›†åˆåˆ›å»º ( æœ¬åœ°å¯¹è±¡è½¬åˆ†å¸ƒå¼RDD )</span></span></li><li id="https://www.notion.so/59a4e90602a94678b7d0ecd2d1361a49" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString">è¯»å–å¤–éƒ¨æ•°æ®æº ( è¯»å–æ–‡ä»¶ )</span></span></li></ol><div id="https://www.notion.so/043c39b44199487eb686a8fcade3e7bf" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">è¿™é‡Œæˆ‘ä»¬é€‰æ‹©è¯»å–HDFSä¸Šçš„txtæ–‡ä»¶åˆ›å»ºRDDï¼Œå¹¶ä»RDDåˆ›å»ºDataFrame</span></span></p></div><pre id="https://www.notion.so/a12fa24479df467d921b4653a0da6057" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token comment"># ä»HDFSçš„txtæ–‡ä»¶ä¸­è·å–RDD</span>
<span class="token keyword">def</span> <span class="token function">get_dataframe_from_txt</span><span class="token punctuation">(</span>hdfsurl<span class="token punctuation">,</span> spark<span class="token punctuation">:</span> SparkSession<span class="token punctuation">)</span><span class="token punctuation">:</span>
     <span class="token comment"># "hdfs://Master:9000/user/hadoop/covid/DXYArea_China.txt"</span>
     <span class="token comment"># åˆ›å»ºRDDæ¨¡å¼</span>
     fields <span class="token operator">=</span> <span class="token punctuation">[</span>StructField<span class="token punctuation">(</span><span class="token string">"continentName"</span><span class="token punctuation">,</span> StringType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># æ´²åç§°</span>
               StructField<span class="token punctuation">(</span><span class="token string">"continentEnglishName"</span><span class="token punctuation">,</span> StringType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># æ´²åç§°è‹±æ–‡</span>
               StructField<span class="token punctuation">(</span><span class="token string">"countryName"</span><span class="token punctuation">,</span> StringType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># å›½å®¶åç§°</span>
               StructField<span class="token punctuation">(</span><span class="token string">"countryEnglishName"</span><span class="token punctuation">,</span> StringType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># å›½å®¶åç§°è‹±æ–‡</span>
               StructField<span class="token punctuation">(</span><span class="token string">"provinceName"</span><span class="token punctuation">,</span> StringType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># çœåç§°</span>
               StructField<span class="token punctuation">(</span><span class="token string">"provinceEnglishName"</span><span class="token punctuation">,</span> StringType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># çœåç§°è‹±æ–‡</span>
               StructField<span class="token punctuation">(</span><span class="token string">"province_zipCode"</span><span class="token punctuation">,</span> StringType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># çœé‚®ç¼–</span>
               StructField<span class="token punctuation">(</span><span class="token string">"province_confirmedCount"</span><span class="token punctuation">,</span> IntegerType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># çœç¡®è¯Šæ•°</span>
               StructField<span class="token punctuation">(</span><span class="token string">"province_suspectedCount"</span><span class="token punctuation">,</span> IntegerType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># çœç–‘ä¼¼ç—…ä¾‹æ•°</span>
               StructField<span class="token punctuation">(</span><span class="token string">"province_curedCount"</span><span class="token punctuation">,</span> IntegerType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># çœæ²»æ„ˆè€…æ•°</span>
               StructField<span class="token punctuation">(</span><span class="token string">"province_deadCount"</span><span class="token punctuation">,</span> IntegerType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># çœæ­»äº¡æ•°</span>
               StructField<span class="token punctuation">(</span><span class="token string">"updateTime"</span><span class="token punctuation">,</span> DateType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># æ›´æ–°æ—¶é—´</span>
               StructField<span class="token punctuation">(</span><span class="token string">"cityName"</span><span class="token punctuation">,</span> StringType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># åŸå¸‚å</span>
               StructField<span class="token punctuation">(</span><span class="token string">"cityEnglishName"</span><span class="token punctuation">,</span> StringType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># åŸå¸‚è‹±æ–‡å</span>
               StructField<span class="token punctuation">(</span><span class="token string">"city_zipCode"</span><span class="token punctuation">,</span> StringType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># åŸå¸‚é‚®ç¼–</span>
               StructField<span class="token punctuation">(</span><span class="token string">"city_confirmedCount"</span><span class="token punctuation">,</span> IntegerType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># åŸå¸‚ç¡®è¯Šæ•°</span>
               StructField<span class="token punctuation">(</span><span class="token string">"city_suspectedCount"</span><span class="token punctuation">,</span> IntegerType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># åŸå¸‚ç–‘ä¼¼ç—…ä¾‹æ•°</span>
               StructField<span class="token punctuation">(</span><span class="token string">"city_curedCount"</span><span class="token punctuation">,</span> IntegerType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># åŸå¸‚æ²»æ„ˆæ•°</span>
               StructField<span class="token punctuation">(</span><span class="token string">"city_deadCount"</span><span class="token punctuation">,</span> IntegerType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">]</span>  <span class="token comment"># åŸå¸‚æ­»äº¡æ•°</span>
     schema <span class="token operator">=</span> StructType<span class="token punctuation">(</span>fields<span class="token punctuation">)</span>     <span class="token comment"># ç”ŸæˆRDD</span>
     rdd0 <span class="token operator">=</span> spark<span class="token punctuation">.</span>sparkContext<span class="token punctuation">.</span>textFile<span class="token punctuation">(</span>hdfsurl<span class="token punctuation">)</span>
     rdd1 <span class="token operator">=</span> rdd0<span class="token punctuation">.</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"\t"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">map</span><span class="token punctuation">(</span>
         <span class="token keyword">lambda</span> p<span class="token punctuation">:</span> Row<span class="token punctuation">(</span>p<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> p<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> p<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> p<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> p<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> p<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span> p<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                       <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token builtin">float</span><span class="token punctuation">(</span>p<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token builtin">float</span><span class="token punctuation">(</span>p<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token builtin">float</span><span class="token punctuation">(</span>p<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token builtin">float</span><span class="token punctuation">(</span>p<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                       toDate<span class="token punctuation">(</span>p<span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> p<span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span><span class="token punctuation">,</span> p<span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span><span class="token punctuation">,</span> p<span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                       <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token builtin">float</span><span class="token punctuation">(</span>p<span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token builtin">float</span><span class="token punctuation">(</span>p<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token builtin">float</span><span class="token punctuation">(</span>p<span class="token punctuation">[</span><span class="token number">17</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token builtin">float</span><span class="token punctuation">(</span>p<span class="token punctuation">[</span><span class="token number">18</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token comment"># ç”ŸæˆDataFrame</span>
     df <span class="token operator">=</span> spark<span class="token punctuation">.</span>createDataFrame<span class="token punctuation">(</span>rdd1<span class="token punctuation">,</span> schema<span class="token punctuation">)</span>
     <span class="token keyword">return</span> df</span></span></span></code></pre><h2 id="https://www.notion.so/7638d749091a4eb9b5564f3e472a65ec" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/7638d749091a4eb9b5564f3e472a65ec"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">ä¸‰ã€DataFrameæ“ä½œ</span></span></h2><div id="https://www.notion.so/139eb8b2160b443bb5cf3e6b9ae5b078" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">DataFrameæ”¯æŒä¸¤ç§é£æ ¼è¿›è¡Œç¼–ç¨‹ï¼Œåˆ†åˆ«æ˜¯ï¼š</span></span></p></div><ol class="NumberedListWrapper"><li id="https://www.notion.so/c9389ec2c77e4f069586bb63eb67fc8b" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">DSLé£æ ¼</span></span><div id="https://www.notion.so/797d38b88b35489486836fdec6b2667f" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">DSLç§°ä¹‹ä¸ºï¼šé¢†åŸŸç‰¹å®šè¯­è¨€ã€‚ å…¶å®å°±æ˜¯æŒ‡DataFrameçš„ç‰¹æœ‰API DSLé£æ ¼æ„æ€å°±æ˜¯ä»¥è°ƒç”¨APIçš„æ–¹å¼æ¥å¤„ç†Data æ¯”å¦‚ï¼šwhere().limit()</span></span></p></div></li><li id="https://www.notion.so/c9da87cca5b44825a5b052cf47dc0318" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString">SQLé£æ ¼</span></span><div id="https://www.notion.so/06dcbdb539504a30a6a1bcb2f2710e7a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">SQLé£æ ¼å°±æ˜¯ä½¿ç”¨SQLè¯­å¥å¤„ç†DataFrameçš„æ•°æ® æ¯”å¦‚ï¼šsql(â€œSELECT * FROM xxx)</span></span></p></div></li></ol><div id="https://www.notion.so/4743529580c04db7af4285fe8f2d3abf" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ä½¿ç”¨sparksqlå¯¹æ•°æ®è¿›è¡Œå¤„ç†å¹¶ç›´æ¥å†™å…¥mysql</span></span></p></div><h3 id="https://www.notion.so/9e159b70d5524a8d807aff7ac79027ef" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/9e159b70d5524a8d807aff7ac79027ef"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">DSLé£æ ¼å¤„ç†åŸå¸‚ä¿¡æ¯</span></span></h3><div id="https://www.notion.so/4e4c218fcce1409fa3de75c4ab30197e" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">ä½¿ç”¨APIå¼çš„SparkSQLï¼Œå¯è¯»æ€§æ›´å¥½ï¼Œå†™èµ·æ¥æ›´ç›´è§‚ï¼Œç¼ºç‚¹æ˜¯å¦‚æœä»…ä»…ä½¿ç”¨SparkSQLæä¾›çš„APIï¼ŒåŠŸèƒ½å—é™ä¸è‡ªç”±ï¼Œé‡å¤è¿­ä»£è®¡ç®—æ€§èƒ½ä¸€èˆ¬ã€‚</span></span></p></div><div id="https://www.notion.so/a862e45ff9a0482f98e841a400aba8ce" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">æ•°æ®åº“ç»“æ„å¦‚ä¸‹</span></span></p></div><div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div><div id="https://www.notion.so/b9bad8c606a44ebaa94722391e328e4a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">å…¶ä¸­ï¼Œé™¤äº†confirm_addå’Œidéœ€è¦è®¡ç®—ï¼Œå…¶ä»–éƒ½å¯ä»¥ä»åŸå§‹çš„DataFrameä¸­è¯»å–å‡ºæ¥</span></span></p></div><ol class="NumberedListWrapper"><li id="https://www.notion.so/778e32cc363f468d80f3c75ac3b73a16" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">confirm_addçš„è®¡ç®—</span></span><div id="https://www.notion.so/ac2b9395e92244379d6f74f6f2469f74" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">sessionWindow =partitionBy(&quot;city&quot;).orderBy(&quot;update_time&quot;) # é™å®šåŸå¸‚å¹¶ä»¥æ—¶é—´ä¸ºä¾æ®</code></span></span></p></div><div id="https://www.notion.so/1ad0b9b8d187402cadea566e68341283" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">åˆ›å»ºä»¥åŸå¸‚ä¸ºåˆ†åŒºï¼Œä»¥æ›´æ–°æ—¶é—´ä¸ºä¾æ®ï¼Œåœ¨confirmæ•°æ®ä¸Šå®ç°é”™ä½ç›¸å‡ï¼Œè®©åä¸€å¤©çš„confirmæ•°æ®è¡¨å‡å»å½“å¤©confirmï¼Œè®¡ç®—å‡ºæ¯æ—¥è¯¥åŸå¸‚çš„æ–°å¢ç¡®è¯Šç—…ä¾‹ã€‚</span></span></p></div></li><li id="https://www.notion.so/5c3e86b2696048d8982a37ebcab0f589" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString">idçš„è®¡ç®—</span></span><div id="https://www.notion.so/1a5ebf4a7af34ca0867fba7850fad862" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">ascendWindow =orderBy(&quot;update_time&quot;) # ç”Ÿæˆé€’å¢åºå·</code></span></span></p></div><div id="https://www.notion.so/af468ca3d8dc4d44ba07b1e7b0e7e30d" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">æ ¹æ®æ—¶é—´åˆ›å»ºé€’å¢åºåˆ—ã€‚</span></span></p></div></li></ol><pre id="https://www.notion.so/6658fbd4e36a40d689e5ece31137d481" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token comment"># DSLé£æ ¼sparksqlï¼Œç”ŸæˆåŸå¸‚æ–°å† ç–«æƒ…ç»Ÿè®¡æ•°æ® </span>
<span class="token keyword">def</span> <span class="token function">store_city_data</span><span class="token punctuation">(</span>df<span class="token punctuation">:</span> DataFrame<span class="token punctuation">)</span><span class="token punctuation">:</span> 
    df1 <span class="token operator">=</span> df<span class="token punctuation">.</span>select<span class="token punctuation">(</span> 
        <span class="token string">"updateTime"</span><span class="token punctuation">,</span> 
        <span class="token string">"provinceName"</span><span class="token punctuation">,</span> 
        <span class="token string">"cityName"</span><span class="token punctuation">,</span> 
        <span class="token string">"city_confirmedCount"</span><span class="token punctuation">,</span> 
        <span class="token string">"city_curedCount"</span><span class="token punctuation">,</span> 
        <span class="token string">"city_deadCount"</span><span class="token punctuation">,</span> 
    <span class="token punctuation">)</span> 
    <span class="token comment"># DataFrameåˆ—é‡å‘½å </span>
    df2 <span class="token operator">=</span> df1<span class="token punctuation">.</span>withColumnRenamed<span class="token punctuation">(</span><span class="token string">"updateTime"</span><span class="token punctuation">,</span> <span class="token string">"update_time"</span><span class="token punctuation">)</span><span class="token punctuation">.</span> \ 
        withColumnRenamed<span class="token punctuation">(</span><span class="token string">"provinceName"</span><span class="token punctuation">,</span> <span class="token string">"province"</span><span class="token punctuation">)</span><span class="token punctuation">.</span> \ 
        withColumnRenamed<span class="token punctuation">(</span><span class="token string">"cityName"</span><span class="token punctuation">,</span> <span class="token string">"city"</span><span class="token punctuation">)</span><span class="token punctuation">.</span> \ 
        withColumnRenamed<span class="token punctuation">(</span><span class="token string">"city_confirmedCount"</span><span class="token punctuation">,</span> <span class="token string">"confirm"</span><span class="token punctuation">)</span><span class="token punctuation">.</span> \ 
        withColumnRenamed<span class="token punctuation">(</span><span class="token string">"city_curedCount"</span><span class="token punctuation">,</span> <span class="token string">"heal"</span><span class="token punctuation">)</span><span class="token punctuation">.</span> \ 
        withColumnRenamed<span class="token punctuation">(</span><span class="token string">"city_deadCount"</span><span class="token punctuation">,</span> <span class="token string">"dead"</span><span class="token punctuation">)</span> 
     <span class="token comment"># æ ¹æ®æ—¶é—´å’ŒåŸå¸‚æŠŠä¸€å¤©å†…å¤šæ¬¡ç»Ÿè®¡çš„ä¿¡æ¯å»é‡ </span>
    df3 <span class="token operator">=</span> df2<span class="token punctuation">.</span>dropDuplicates<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'update_time'</span><span class="token punctuation">,</span> <span class="token string">'city'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> 
     <span class="token comment"># æ ¹æ®æ—¶é—´æ’åº </span>
    df4 <span class="token operator">=</span> df3<span class="token punctuation">.</span>sort<span class="token punctuation">(</span>df3<span class="token punctuation">[</span><span class="token string">"update_time"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>asc<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
     <span class="token comment"># åˆ›å»ºçª—å£å‡½æ•° </span>
    sessionWindow <span class="token operator">=</span> Window<span class="token punctuation">.</span>partitionBy<span class="token punctuation">(</span><span class="token string">"city"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>orderBy<span class="token punctuation">(</span><span class="token string">"update_time"</span><span class="token punctuation">)</span> 
      <span class="token comment"># é™å®šåŸå¸‚å¹¶ä»¥æ—¶é—´ä¸ºä¾æ® </span>
    ascendWindow <span class="token operator">=</span> Window<span class="token punctuation">.</span>orderBy<span class="token punctuation">(</span><span class="token string">"update_time"</span><span class="token punctuation">)</span> 
                           <span class="token comment"># ç”Ÿæˆé€’å¢åºå· </span>
    df5 <span class="token operator">=</span> df4<span class="token punctuation">.</span>withColumn<span class="token punctuation">(</span><span class="token string">"confirm_add"</span><span class="token punctuation">,</span> 
                         func<span class="token punctuation">.</span>lag<span class="token punctuation">(</span>df4<span class="token punctuation">[</span><span class="token string">"confirm"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>over<span class="token punctuation">(</span>sessionWindow<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span> \ 
        withColumn<span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">,</span> func<span class="token punctuation">.</span>row_number<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>over<span class="token punctuation">(</span>ascendWindow<span class="token punctuation">)</span><span class="token punctuation">)</span> 
          <span class="token comment"># è¿æ¥å¹¶ä¿å­˜åˆ°mysql </span>
    df5<span class="token punctuation">.</span>write<span class="token punctuation">.</span>mode<span class="token punctuation">(</span><span class="token string">"overwrite"</span><span class="token punctuation">)</span><span class="token punctuation">.</span> \ 
        <span class="token builtin">format</span><span class="token punctuation">(</span><span class="token string">"jdbc"</span><span class="token punctuation">)</span><span class="token punctuation">.</span> \ 
        option<span class="token punctuation">(</span><span class="token string">"url"</span><span class="token punctuation">,</span> <span class="token string">"jdbc:mysql://Master:3306/covid?useSSL=false&amp;useUnicode=true"</span><span class="token punctuation">)</span><span class="token punctuation">.</span> \ 
        option<span class="token punctuation">(</span><span class="token string">"dbtable"</span><span class="token punctuation">,</span> <span class="token string">"details"</span><span class="token punctuation">)</span><span class="token punctuation">.</span> \ 
        option<span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">,</span> <span class="token string">"root"</span><span class="token punctuation">)</span><span class="token punctuation">.</span> \ 
        option<span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">,</span> <span class="token string">"HUSTeic2021"</span><span class="token punctuation">)</span><span class="token punctuation">.</span> \ 
        save<span class="token punctuation">(</span><span class="token punctuation">)</span></span></span></span></code></pre><div id="https://www.notion.so/268eff838fb34d8eb6843fd3fd29226a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">ç”Ÿæˆçš„æ•°æ®åº“æ ¼å¼å’ŒDataFrameçš„æ ¼å¼ä¸€è‡´</span></span></p></div><div id="https://www.notion.so/321c0f2e1ba3456d83674c51c8c53d6e" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fad3cc581-5b77-4301-91ad-82483c6c51d7%2FUntitled.png?width=840&amp;table=block&amp;id=321c0f2e-1ba3-456d-8367-4c51c8c53d6e"><img src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fad3cc581-5b77-4301-91ad-82483c6c51d7%2FUntitled.png?width=840&amp;table=block&amp;id=321c0f2e-1ba3-456d-8367-4c51c8c53d6e" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><h3 id="https://www.notion.so/debbc1b04c474152a7ac9f67c3f85d50" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/debbc1b04c474152a7ac9f67c3f85d50"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">SQLé£æ ¼å¤„ç†å…¨å›½ä¿¡æ¯</span></span></h3><div id="https://www.notion.so/9226e91c841b43d2865274e65143e497" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">ä½¿ç”¨é€šç”¨SQLå½¢å¼çš„SparkSQLï¼Œä¼˜ç‚¹æ˜¯æ¥å—åº¦é«˜ï¼Œè€Œä¸”ä»DataFrameç”Ÿæˆä¸´æ—¶è¡¨ååœ¨ä½¿ç”¨SQLæŸ¥è¯¢æ•ˆç‡æ›´é«˜ï¼Œè€Œä¸”èƒ½å®ç°å¾ˆå¤šå¤æ‚æ“ä½œï¼Œç¼ºç‚¹æ˜¯å¯è¯»æ€§ä¸å¦‚DSLã€‚</span></span></p></div><div id="https://www.notion.so/bd04409da3f2466bb3de85489b0a5cc9" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">æ•°æ®åº“ç»“æ„å¦‚ä¸‹</span></span></p></div><div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div><div id="https://www.notion.so/4711bfa0387b434a95c3f82e25374619" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">è®¡ç®—å…¨å›½æ•°æ®çš„æ€è·¯å¦‚ä¸‹</span></span></p></div><ol class="NumberedListWrapper"><li id="https://www.notion.so/ebeda8551d5142caac827dfc90fcb8c6" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">æˆ‘ä»¬æœ‰å„ä¸ªçœä»½æ¯å¤©éƒ½ç¡®è¯Šï¼Œç–‘ä¼¼ï¼Œæ²»æ„ˆï¼Œæ­»äº¡æ•°æ®ï¼Œä½†æ˜¯ä¸æ˜¯æ¯å¤©éƒ½æœ‰å„ä¸ªçœä»½çš„æ•°æ®ã€‚å¦‚æœæƒ³è¦è®¡ç®—å…¨å›½æ•°æ®çš„è¯ä¸èƒ½ç›´æ¥ç®€å•ç›¸åŠ </span></span></li><li id="https://www.notion.so/26e14fbc210f4de692036baad3791a61" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString">ç”±ä¸Šä¸€ä¸ªæ•°æ®åº“å»ºç«‹çš„æ€æƒ³å¯ä»¥å»¶ä¼¸åˆ°æœ¬æ¬¡è®¡ç®—ï¼Œé¦–å…ˆè®¡ç®—æ¯æ—¥æ¯çœæ•°æ®æ–°å¢ï¼ŒæŒ‰ç…§æ—¶é—´æ¥åˆ†ç»„ï¼Œè®¡ç®—æ¯ç»„å„ä¸ªæ•°æ®ä¹‹å’Œå³æ˜¯æ¯æ—¥æ–°å¢æ•°æ®</span></span></li><li id="https://www.notion.so/8843ec0ccfa54392983a454e599121ee" class="NumberedList" value="3"><span class="SemanticStringArray"><span class="SemanticString">è·å¾—æ¯æ—¥æ–°å¢æ•°æ®åï¼Œå¯ä»¥ç´¯åŠ é€æ—¥æ•°æ®æ¥è®¡ç®—æ¯æ—¥çš„ç´¯è®¡æ•°æ®</span></span></li></ol><pre id="https://www.notion.so/f6667b34fe6445ea995f6b6fea00368a" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token comment"># SQLé£æ ¼sparksqlï¼Œç”Ÿæˆå…¨å›½ç–«æƒ…ç»Ÿè®¡ </span>
<span class="token keyword">def</span> <span class="token function">store_history_data</span><span class="token punctuation">(</span>df<span class="token punctuation">:</span> DataFrame<span class="token punctuation">,</span> sc<span class="token punctuation">:</span> SparkSession<span class="token punctuation">)</span><span class="token punctuation">:</span>
     <span class="token comment"># ä»DataFrameä¸­é€‰æ‹©åˆé€‚çš„æ•°æ®åˆ›å»ºæ–°çš„DataFrame</span>
     df1 <span class="token operator">=</span> df<span class="token punctuation">.</span>select<span class="token punctuation">(</span>
         <span class="token string">"updateTime"</span><span class="token punctuation">,</span>
	        <span class="token comment"># æ›´æ–°æ—¶é—´</span>
         <span class="token string">"provinceName"</span><span class="token punctuation">,</span>
	        <span class="token comment"># çœåç§°</span>
         <span class="token string">"province_confirmedCount"</span><span class="token punctuation">,</span>
          <span class="token comment"># çœç¡®è®¤æ•°</span>
         <span class="token string">"province_suspectedCount"</span><span class="token punctuation">,</span>
          <span class="token comment"># çœç–‘ä¼¼æ•°</span>
         <span class="token string">"province_curedCount"</span><span class="token punctuation">,</span>
          <span class="token comment"># çœæ²»æ„ˆæ•°</span>
         <span class="token string">"province_deadCount"</span>
          <span class="token comment"># çœæ­»äº¡æ•°</span>
     <span class="token punctuation">)</span>
          <span class="token comment"># æ ¹æ®æ›´æ–°æ—¶é—´å’Œçœåç§°å»é‡</span>
     df2 <span class="token operator">=</span> df1<span class="token punctuation">.</span>dropDuplicates<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'updateTime'</span><span class="token punctuation">,</span> <span class="token string">'provinceName'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
          <span class="token comment"># æ ¹æ®æ—¶é—´å‡åºæ’åº</span>
     df3 <span class="token operator">=</span> df2<span class="token punctuation">.</span>sort<span class="token punctuation">(</span>df2<span class="token punctuation">[</span><span class="token string">"updateTime"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>asc<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token comment"># ç”±RDDåˆ›å»ºä¸´æ—¶è¡¨</span>
     df3<span class="token punctuation">.</span>createOrReplaceTempView<span class="token punctuation">(</span><span class="token string">"cntotal"</span><span class="token punctuation">)</span>
          <span class="token comment"># è®¡ç®—ç–‘ä¼¼ç—…ä¾‹</span>
     suspect_df <span class="token operator">=</span> sc<span class="token punctuation">.</span>sql<span class="token punctuation">(</span><span class="token string">"select updateTime as ds1,"</span>
                         <span class="token string">"sum(province_suspectedCount) "</span>
                         <span class="token string">"as suspect from cntotal group by updateTime"</span><span class="token punctuation">)</span>
          <span class="token comment"># è®¡ç®—æ¯ä¸ªçœä»½å¯¹äºä¸Šæ¬¡æ—¶é—´çš„æ–°å¢æ•°æ®å·®</span>
     raw_df <span class="token operator">=</span> sc<span class="token punctuation">.</span>sql<span class="token punctuation">(</span><span class="token string">"select t1.updateTime as ds,"</span>
                     <span class="token string">"t1.province_confirmedCount as confirm,"</span>
                     <span class="token string">"t1.province_suspectedCount as suspect,"</span>
                     <span class="token string">"t1.province_curedCount as heal, "</span>
                     <span class="token string">"t1.province_deadCount as dead, "</span>
                     <span class="token string">"t1.province_confirmedCount-t2.province_confirmedCount as confirm_add, "</span>
                     <span class="token string">"t1.province_suspectedCount-t2.province_suspectedCount as suspect_add, "</span>
                     <span class="token string">"t1.province_curedCount-t2.province_curedCount as heal_add, "</span>
                     <span class="token string">"t1.province_deadCount-t2.province_deadCount as dead_add"</span>
                     <span class="token string">" from cntotal t1,"</span>
                     <span class="token string">"cntotal t2 where t1.updateTime = date_add(t2.updateTime,1) and t1.provinceName = t2.provinceName"</span><span class="token punctuation">)</span>
     raw_df<span class="token punctuation">.</span>createOrReplaceTempView<span class="token punctuation">(</span><span class="token string">"cntotal"</span><span class="token punctuation">)</span>
       <span class="token comment"># åˆ›å»ºä¸´æ—¶è¡¨</span>
          <span class="token comment"># è®¡ç®—å…¨å›½æ¯æ—¥æ–°å¢æ•°æ®</span>
     diff <span class="token operator">=</span> sc<span class="token punctuation">.</span>sql<span class="token punctuation">(</span><span class="token string">"select ds, sum(confirm_add) as confirm_add, "</span>                   <span class="token string">"sum(suspect_add) as suspect_add, "</span>                   <span class="token string">"sum(heal_add) as heal_add, "</span>                   <span class="token string">"sum(dead_add) as dead_add from cntotal group by ds"</span><span class="token punctuation">)</span>     diff<span class="token punctuation">.</span>createOrReplaceTempView<span class="token punctuation">(</span><span class="token string">"cntotal"</span><span class="token punctuation">)</span>         <span class="token comment"># åˆ›å»ºä¸´æ—¶è¡¨          # è®¡ç®—å…¨å›½é€æ—¥ç´¯è®¡æ•°æ®     cum = sc.sql("select ds as ds1, "                  "sum(confirm_add) over(order by ds asc)as confirm , "                  "sum(heal_add) over(order by ds asc) as heal, "                  "sum(dead_add) over(order by ds asc) as dead "                  "from cntotal")          # å°†DataFrameè¿›è¡Œè¿æ¥æ“ä½œï¼Œä½¿å¾—ä¸‰ä¸ªDataFrameåˆæˆä¸€ä¸ª     history = diff.join(suspect_df, suspect_df["ds1"] == diff["ds"], "inner")     history = history.join(cum, cum["ds1"] == history["ds"], "inner")     history = history.drop("ds1").sort(history["ds"].asc())          # å°†DataFrameå†™å…¥mysql     history.write.mode("overwrite"). \         format("jdbc"). \         option("url", "jdbc:mysql://Master:3306/covid?useSSL=false&amp;useUnicode=true"). \         option("dbtable", "history"). \         option("user", "root"). \         option("password", "HUSTeic2021"). \         save()</span></span></span></span></code></pre><div id="https://www.notion.so/96c840c817104eadbb0fd9cfb1bf776c" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">ç”Ÿæˆçš„æ•°æ®åº“æ ¼å¼å’ŒDataFrameçš„æ ¼å¼ä¸€è‡´</span></span></p></div><div id="https://www.notion.so/db460d152865402fbb2200286147b2be" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fec2d1b7c-77ac-479d-9406-8b80cf21e7b2%2FUntitled.png?width=840&amp;table=block&amp;id=db460d15-2865-402f-bb22-00286147b2be"><img src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fec2d1b7c-77ac-479d-9406-8b80cf21e7b2%2FUntitled.png?width=840&amp;table=block&amp;id=db460d15-2865-402f-bb22-00286147b2be" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div></article>
    <script src="https://utteranc.es/client.js"
        repo="youthtoday/youthtoday.github.io"
        issue-term="pathname"
        label="âœ¨"
        theme="github-light"
        crossorigin="anonymous"
        async>
    </script>
  <footer class="Footer">
  <div>&copy; Nickçš„åšå®¢ 2022</div>
  <div>&centerdot;</div>
  <div>Powered by <a href="https://github.com/dragonman225/notablog" target="_blank"
      rel="noopener noreferrer">Notablog</a>.
  </div>
</footer>
</body>

</html>
